# Commit Convention (Background Fixes)

## Format
```
<type>(<scope>): <short summary> (#issue)

<optional body with details>

<optional footer with breaking changes, links, etc.>
```

## Types
- `fix(bg)` — Functional defect / bug fix
- `test(bg)` — Test addition or modification
- `perf(bg)` — Performance improvement
- `security(bg)` — Security vulnerability fix
- `chore(obs)` — Observability enhancement (logs, metrics, traces)
- `chore(deps)` — Dependency updates (security patches)
- `refactor(bg)` — Code refactoring without behavior change
- `docs(bg)` — Documentation updates
- `revert` — Rollback of previous commit

## Scopes (Common Areas)
- `auth` — Authentication/authorization
- `api` — API endpoints/server actions
- `db` — Database queries/migrations
- `payments` — Payment processing
- `i18n` — Internationalization
- `state` — State management (Zustand)
- `validation` — Input/schema validation
- `error-handling` — Error handling logic
- `monitoring` — Monitoring/alerting

## Examples

### Bug Fixes
```
fix(bg): use formatSAR instead of Intl.NumberFormat('en-US') (#1243)

Replaced hard-coded 'en-US' locale with dynamic locale detection
from document.lang to support Arabic (SAR) formatting.

Test: src/utils/__tests__/formatCurrency.test.ts
```

```
fix(bg): prevent race condition in payment status updates (#1456)

Added optimistic locking with version field to prevent concurrent
updates from overwriting each other.

Risk: Low - includes rollback via feature flag ENABLE_PAYMENT_LOCKING
```

### Performance Improvements
```
perf(bg): batch invoice lookups to eliminate N+1 in payments (#2034)

Reduced 50+ individual queries to single batched query, improving
response time from 2.3s to 180ms for payment dashboard.

Before: 2300ms avg response time
After: 180ms avg response time
```

```
perf(bg): add index on conversations.engineer_id for faster queries (#2156)

Migration adds index to support engineer dashboard queries.
Reduces query time from 850ms to 45ms for engineers with 100+ conversations.
```

### Security Fixes
```
security(bg): sanitize HTML in message content before rendering (#3001)

Added DOMPurify to sanitize user-generated HTML content,
preventing stored XSS attacks in conversation messages.

CVE: Internal finding, no public disclosure
Risk: High - deployed with feature flag for gradual rollout
```

```
security(bg): add RBAC check for admin-only invoice endpoints (#3045)

Missing auth check allowed any authenticated user to access
admin invoice endpoints. Added RequireRole('admin') middleware.

Risk: Critical - hotfix deployed immediately
```

### Observability
```
chore(obs): add structured logging with trace IDs for auth flow (#4012)

Added requestId, userId, and traceId to all auth-related logs
for easier debugging of authentication issues.

Includes new metrics: auth_success_rate, auth_failure_by_reason
```

```
chore(obs): configure alerts for elevated error rates in payments (#4089)

Added PagerDuty alerts for:
- Payment failure rate >5% over 5min
- Payment processing time >30s p95
- Payment retry exhaustion >10/min
```

### Testing
```
test(bg): add failing test for null engineer_id in job matching (#5001)

Reproduces bug where null engineer_id causes job matcher to crash.
Test currently fails; fix will come in next commit.
```

```
test(bg): add integration tests for payment webhook handling (#5123)

Covers success, failure, and idempotency scenarios for Stripe webhooks.
Includes tests for duplicate webhook handling and signature verification.
```

### Reverts
```
revert: abc1234 because payment locking caused deadlocks (#6001)

Reverting "fix(bg): prevent race condition in payment status updates"
due to database deadlocks in production under high load.

Root cause analysis in progress; will re-implement with different approach.
```

## Commit Message Best Practices

### DO:
- ✅ Use present tense ("add feature" not "added feature")
- ✅ Use imperative mood ("move cursor to" not "moves cursor to")
- ✅ Keep subject line under 72 characters
- ✅ Reference issue number in subject line
- ✅ Explain **why** in the body, not just **what**
- ✅ Include risk level for production changes
- ✅ Mention feature flags, rollback plans
- ✅ Link to tests, dashboards, docs
- ✅ Include before/after metrics for performance changes

### DON'T:
- ❌ Combine multiple unrelated changes in one commit
- ❌ Use vague messages like "fix bug" or "update code"
- ❌ Omit issue numbers for bug fixes
- ❌ Forget to mention breaking changes
- ❌ Skip explaining risky changes
- ❌ Leave TODOs or FIXMEs in production code

## Breaking Changes

If a commit introduces breaking changes, add to footer:

```
fix(bg): change invoice API response format for consistency (#7001)

Standardized invoice API to return { data, meta } instead of flat object.

BREAKING CHANGE: Invoice API response format changed.
Migration guide: docs/migrations/invoice-api-v2.md
Deprecation timeline: Old format supported until 2025-12-31
```

## Co-authored Commits

For pair programming or collaborative fixes:

```
fix(bg): resolve memory leak in conversation polling (#8001)

Co-authored-by: Jane Developer <jane@example.com>
Co-authored-by: John Engineer <john@example.com>
```
